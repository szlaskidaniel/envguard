# EnvGuard ğŸ”

Keep your environment variables in sync with your codebase.

## The Problem

- `.env.example` is always out of sync with actual `.env`
- New developers don't know what environment variables they need
- Production secrets accidentally committed
- Dead environment variables cluttering your config

## The Solution

EnvGuard automatically:
- Scans your codebase for `process.env.*` usage
- Compares with your `.env` and `.env.example` files
- **Supports Serverless Framework** - scans `serverless.yml` environment configurations
- Alerts you to missing, unused, or undocumented variables
- Auto-generates `.env.example` with helpful comments
- **Supports multiple `.env` files** in subdirectories (monorepo-friendly!)

## Installation

```bash
npm install -g envguard
```

Or use with npx:

```bash
npx envguard scan
```

## Usage

### Scan for issues

```bash
envguard scan
```

Example output:

```
ğŸ” Scanning codebase for environment variables...

âœ“ Found 12 unique environment variables in code
âœ“ Found 10 variables in .env
âœ“ Found 8 variables in .env.example

âš ï¸  Found 5 issue(s):

ğŸš¨ Missing from .env:
  1. STRIPE_SECRET_KEY
     Used in: src/payment.js, src/checkout.ts
  2. API_KEY
     Used in: src/api/client.ts

âš ï¸  Unused variables (consider removing):
  1. OLD_API_URL
     Defined in .env but never used in code

ğŸ“ Missing from .env.example:
  1. DATABASE_URL
     Used in: src/db/connection.ts
  2. JWT_SECRET
     Used in: src/auth/jwt.ts

ğŸ’¡ Run `envguard fix` to auto-generate .env.example
```

### Auto-generate .env.example

```bash
envguard fix
```

This will create/update `.env.example` files with:
- All environment variables used in your code
- Comments showing where each variable is used
- Format hints for common variable types (URLs, ports, etc.)
- **Creates `.env.example` next to each `.env` file** (great for monorepos!)

Example generated `.env.example`:

```bash
# Auto-generated by envguard
# Do not put actual secrets in this file - use .env instead

# Used in: src/db/connection.ts:12, src/models/user.ts:5
# Format: postgresql://user:pass@host:5432/db
DATABASE_URL=

# Used in: src/payment.js:23
# Format: sk_test_...
STRIPE_SECRET_KEY=

# Used in: src/server.ts:8
# Format: 3000
PORT=
```

### CI/CD Integration

Use the `check` command in your CI pipeline to fail builds if environment variables are out of sync:

```bash
envguard check
```

This is equivalent to `envguard scan --ci` and will exit with code 1 if issues are found.

#### GitHub Actions Example

```yaml
name: Check Env Sync
on: [pull_request]

jobs:
  envguard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npx envguard check
```

## Supported Languages & Frameworks

### JavaScript/TypeScript
- JavaScript (`.js`, `.mjs`, `.cjs`)
- TypeScript (`.ts`, `.tsx`)
- JSX (`.jsx`)

Detects:
- `process.env.VAR_NAME`
- `process.env['VAR_NAME']`
- `const { VAR_NAME } = process.env`

### Serverless Framework
- Automatically detects `serverless.yml` and `serverless.yaml` files
- Scans `provider.environment` section
- Scans function-level `environment` sections
- Detects references to external sources (SSM, Secrets Manager, etc.)
- Validates that all defined variables are used in code
- Reports variables used in code but not defined in serverless.yml

## Configuration

EnvGuard works out of the box with sensible defaults. It automatically excludes:
- `node_modules`
- `dist`
- `build`
- `.git`

### Custom Configuration

Create a `.envguardrc.json` file in your project root to customize behavior:

```json
{
  "ignoreVars": [
    "MY_CUSTOM_VAR",
    "ANOTHER_VAR",
    "COMPANY_INTERNAL_VAR"
  ],
  "strict": false,
  "exclude": [
    "**/build/**",
    "**/tmp/**"
  ]
}
```

**Configuration options:**

- `ignoreVars` (string[]): Custom environment variables to ignore in non-strict mode. These will be treated like AWS_REGION and won't trigger warnings.
- `strict` (boolean): Enable strict mode by default (can be overridden with CLI flag)
- `exclude` (string[]): Additional file patterns to exclude from scanning

**Alternative: package.json**

You can also add configuration to your `package.json`:

```json
{
  "envguard": {
    "ignoreVars": ["MY_CUSTOM_VAR"],
    "strict": false
  }
}
```

**Use case for ignoreVars:**
- Company-wide variables that are always available (injected by infrastructure)
- Framework-specific variables you don't need to track
- Variables provided by your deployment platform (Vercel, Netlify, etc.)
- Custom variables for GitHub Apps or CI/CD integrations

**Priority:** CLI flags > `.envguardrc.json` > `package.json` > defaults

**GitHub Apps & CI/CD:**
When using EnvGuard as a GitHub App or in CI/CD pipelines, commit your `.envguardrc.json` to the repository. This ensures consistent behavior across all environments and team members.

### Monorepo Support

EnvGuard automatically detects all `.env` files in your project, including subdirectories. When you run `envguard fix`, it creates a `.env.example` file next to each `.env` file it finds.

Example structure:
```
project/
â”œâ”€â”€ .env              â†’ generates .env.example
â”œâ”€â”€ src/
â”‚   â””â”€â”€ lambda1/
â”‚       â”œâ”€â”€ .env      â†’ generates lambda1/.env.example
â”‚       â””â”€â”€ handler.js
â””â”€â”€ services/
    â””â”€â”€ api/
        â”œâ”€â”€ .env      â†’ generates api/.env.example
        â””â”€â”€ server.js
```

Each `.env.example` only includes variables used in that directory and its subdirectories.

## Serverless Framework Support

EnvGuard can scan `serverless.yml` files as a standalone source of environment variable definitions. This is useful for AWS Lambda projects where environment variables are defined in the serverless configuration rather than `.env` files.

### How it works

1. **Detects** `serverless.yml` files in your project
2. **Extracts** environment variables from `provider.environment` and function-level `environment` sections
3. **Validates** that all defined variables are actually used in your Lambda code
4. **Reports** unused variables and missing definitions

### Example serverless.yml

```yaml
provider:
  name: aws
  runtime: nodejs20.x
  environment:
    NODE_ENV: ${opt:stage}
    API_KEY: ${ssm:/my-app/api-key}
    DATABASE_URL: ${self:custom.dbUrl}
```

### Scan output for serverless.yml

```
ğŸ“‚ Checking src/lambda/serverless.yml

   Found 3 variable(s) in serverless.yml
   Found 2 variable(s) used in code

   âš ï¸  Unused variables in serverless.yml:
      1. DATABASE_URL

   ğŸš¨ Missing from serverless.yml:
      1. LOG_LEVEL
         Used in: src/lambda/handler.js
```

### Key Features

- **No .env required** - serverless.yml is treated as a standalone configuration source
- **CloudFormation intrinsic functions** - Supports `!Ref`, `!GetAtt`, `!Sub`, `!ImportValue`, and all CF functions
- **External references** - Detects SSM parameters, Secrets Manager, CloudFormation outputs
- **Function-level variables** - Scans both provider-level and function-specific environment vars
- **Smart filtering** - Automatically skips AWS/runtime variables (disable with `--strict`)
- **CI/CD validation** - Use `envguard check` to enforce serverless config completeness

## Commands

- `envguard scan` - Scan for issues and display report
- `envguard scan --ci` - Scan and exit with error code if issues found
- `envguard scan --strict` - Report all variables including known runtime variables
- `envguard fix` - Auto-generate `.env.example`
- `envguard check` - Alias for `scan --ci`
- `envguard check --strict` - Check with strict mode enabled

### Strict Mode

By default, EnvGuard filters out well-known runtime variables that don't need to be explicitly defined:

**AWS Lambda variables**: `AWS_REGION`, `AWS_LAMBDA_FUNCTION_NAME`, etc.
**Node.js runtime**: `NODE_ENV`, `PATH`, etc.
**CI/CD environments**: `CI`, `GITHUB_ACTIONS`, etc.
**Serverless Framework**: `IS_OFFLINE`, `SLS_OFFLINE`, etc.

Use `--strict` mode to report ALL variables including these runtime-provided ones:

```bash
envguard scan --strict
```

Example output (non-strict):
```
â„¹ï¸  Skipped known runtime variables (use --strict to show):
   Serverless Framework: IS_OFFLINE, SLS_OFFLINE
   CI/CD: CI
   AWS Lambda: AWS_REGION
```

## Development

```bash
# Install dependencies
npm install

# Build
npm run build

# Run locally
npm start scan
```

## License

MIT
